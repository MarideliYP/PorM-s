{% load static %}

<header class="root__header shadow-sm pb-2 position-fixed w-100 top-0" style="z-index: 7000">
     <div class="header__content align-items-center justify-content-between d-flex">
        <figure class="header__logo">
            <img src="{% static 'img/logo.png' %}" alt="">
        </figure>

        <figure class="header__menu">
        </figure>

        <figure class="header__menu--close">
        </figure>
    </div>

    <nav class="nav">

        <div class="nav__content d-block">

            <div class="nav__search ms-1 me-1 mt-1">

                <form action="{% url 'producto:buscar' %}" method="POST" class="nav__form">
                    {% csrf_token %}
                    <input
                        type="search"
                        name="buscar_nombre"
                        class="input__search"
                        placeholder="Buscar"
                        required>
                    <button type="submit" class="nav__button--send">
                        <img class="nav__button--sendi" src="{% static 'svg/search.svg' %}" alt="Buscar">
                    </button>
                </form>

                <div class="nav__login ms-1 me-1">
                    {% if user.is_authenticated %}
                        <button class="btn rounded-5" type="button" data-bs-toggle="offcanvas" data-bs-target="#perfilusuario" aria-controls="offcanvasRight" style="background-image: url('{{ user.image.url }}'); background-position: center; background-size: cover; width: 2em; height: 2em;"></button>
                        <a class="login__link login__link--user" href="{% url "user:logout" %}">
                            <img src="{% static 'svg/arrow-left-to-bracket.svg' %}" class="nav__user me-1" alt="">
                            <span>Cerrar Sesión</span>
                        </a>
                    {% else %}
                        <a href="{% url 'user:login' %}" class="login__link login__link--user ">
                            <span>Iniciar Sesión</span>
                            <img src="{% static 'svg/arrow-right-to-bracket.svg' %}" class="nav__user" alt="">
                        </a>
                        <a href="{% url 'user:register' %}" class="login__link login__link--register">
                            <span>Registrarse</span>
                            <img src="{% static 'svg/user-plus.svg' %}" class="nav__user ms-1" alt="">
                        </a>
                    {% endif %}
                </div>
            </div>

            <ul class="nav__menu mb-0 mt-1 d-flex flex-wrap justify-content-between">
                <li class="menu__item">
                    <a href="{% url 'index' %}" class="nav__link">Inicio</a>
                </li>
                {% if user.is_staff %}
                    <li class="menu__item">
                        <span class="nav__parent">Usuarios<img class="nav__parent--img mt-1" src="{% static 'svg/caret-down.svg' %}" alt=""></span>
                        <ul class="nav__submenu ps-0">
                            <li class="item__submenu"><a class="nav__dropdown" href="{% url "user:list" %}"> Listar Usuarios</a>
                            </li>
                            <li class="item__submenu"><a class="nav__dropdown" href="{% url "user:register" %}"> Nuevo Usuario</a>
                            </li>
                        </ul>
                    </li>
                {% endif %}

                {% if is_Repartidor %}
                    <li class="menu__item">
                        <a class="nav__link text-danger" href="{% url 'producto:repartidor' %}">Entregas pendientes</a>
                    </li>
                {% endif %}

                    <li class="menu__item">
                        <a class="nav__link" href="{% url 'index' %}#inmueble">Inmuebles</a>
                    </li>

                    <li class="menu__item">
                        <a class="nav__link" href="{% url 'index' %}#empresas">Empresas</a>
                    </li>

                    <li class="menu__item">
                        <a class="nav__link" href="{% url 'index' %}#specials">Ofertas</a>
                    </li>

                    <li class="menu__item">
                        <a class="nav__link" href="{% url 'index' %}#events">Eventos</a>
                    </li>

                    <li class="menu__item">
                        <a class="nav__link" href="{% url 'index' %}#productos">Productos</a>
                    </li>

                    <li class="menu__item border-end-0">
                        <span class="nav__parent">Contactos<img class="nav__parent--img mt-1" src="{% static 'svg/caret-down.svg' %}" alt=""></span>
                        <ul class="nav__submenu ps-0">
                            <li class="item__submenu"><p class="nav__dropdown"> +53 </p></li>
                            <li class="item__submenu"><p class="nav__dropdown"> +53 </p></li>
                            <li class="item__submenu"><p class="nav__dropdown"> +53 </p></li>
                            <li class="item__submenu"><p class="nav__dropdown"> +53 </p></li>
                        </ul>
                    </li>

                <li class="submenu nav-link scrollto p-0 me-5" id="carrito">
                    <img src="{% static 'img/car.png' %}" id="img-carrito" alt="car" class="pb-1" style="width: 40px; height: 40px">
                    <div id="carrito-div" class="rounded-3 p-3 ">
                        {% if articulos.count > 0 %}
                                <table id="lista-carrito" class="text-light" >
                                    <thead class="m-2 p-2 text-center " >
                                        <td>Artículo</td>
                                        <td>Tipo</td>
                                        <td>Cantidad</td>
                                        <td>Precio</td>
                                        <td>Acciones</td>
                                    </thead>
                                    <tbody class="table-group-divider p-2 m-2 text-center">
                                        {% for articulo in articulos %}
                                            <tr class="me-2">
                                                {% if articulo.producto is not None %}
                                                    <td style="width: 5em;">{{ articulo.producto.nombreP }}</td>
                                                    <td style="width: 5em;">Producto</td>
                                                    <td style="width: 5em;">{{ articulo.cantidad }}</td>
                                                    <td style="width: 5em;">${{ articulo.producto.precio }}</td>
                                                {% elif articulo.oferta is not None %}
                                                    <td style="width: 5em;">{{ articulo.oferta.nombreO }}</td>
                                                    <td style="width: 5em;">Oferta</td>
                                                    <td style="width: 5em;">{{ articulo.cantidad }}</td>
                                                    <td style="width: 5em;">${{ articulo.oferta.precio }}</td>
                                                {% endif %}
                                                <td style="width: 5em;">
                                                    <div class="d-flex justify-content-between me-3" >
                                                      <a class="animated" href="{% url "producto:ajustar-carrito-item" articulo.pk "up" %}"><i class="bi bi-plus-circle-dotted"></i></a>
                                                      <a class="animated" href="{% url "producto:ajustar-carrito-item" articulo.pk "down" %}"><i class="bi bi-dash-circle-dotted"></i></a>
                                                      <a href="{% url "producto:eliminar-carrito-item" articulo.pk %}" class="animated"><i class="bi bi-trash "></i></a>
                                                    </div>
                                                </td>
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            <div class="d-flex justify-content-between justify-content-end mt-3">
                            <i class="ms-3 text-light">Cuenta total: ${{ precio_total }}</i>
                                <button type="button" class="btn btn-success d-flex justify-content-center"
                                        onclick="abrirModalPagar('carro', {{ carrito.pk }})">
                                    Pagar
                                </button>
{#                            <a href="{% url "producto:enviar-carrito" %}" class="btn btn-success d-flex justify-content-center text-center" style="max-width: 50%; padding-right: 5% ">#}
{#                                Enviar#}
{#                            </a>#}
                            </div>
                        {% else %}
                            <div class="text-secondary text-center">
                                {% if user.is_authenticated %}
                                    <h2>Parece que no tienes artículos en tu carrito todavía</h2>
                                {% else %}
                                    <h3>Debes registrarte para poder añadir artículos en tu carrito</h3>
                                {% endif %}
                            </div>
                        {% endif %}
                    </div>
                </li>

                <li class="menu__item menu__item--icons nav-link border-end-0 me-2">
                    <a href="#" class="nav__icon">
                        <img src="{% static 'svg/whatsapp.svg' %}" class="nav__icon--img" alt="">
                    </a>
                    <a href="{% url 'producto:ir_facebook' %}" class="nav__icon" target="_blank" rel="noopener noreferrer">
                        <img src="{% static 'svg/facebook.svg' %}" class="nav__icon--img" alt="Grupo de Facebook">
                    </a>
                    <a href="#" class="nav__icon">
                        <img src="{% static 'svg/telegram.svg' %}" class="nav__icon--img" alt="">
                    </a>
                    <a href="#" class="nav__icon">
                        <img src="{% static 'svg/instagram.svg' %}" class="nav__icon--img" alt="">
                    </a>
                </li>
            </ul>
        </div>
    </nav>
    {% if user.is_authenticated %}
        <div class="offcanvas offcanvas-end" data-bs-scroll="true" tabindex="-1" id="perfilusuario" aria-labelledby="offcanvasRightLabel" style="z-index: 5000;">

          <div class="offcanvas-header">
            <a href="{% url 'user:update' user.pk %}">
                <img src="{{ user.image.url }}" alt="{{ usuario }}" style=" width: 6em; height: 6em; border-radius: 5em">
            </a>
            <div class="d-flex text-center flex-column align-bottom">
              <h5 class="offcanvas-title" id="offcanvasRightLabel">{{ user.username }}</h5>
              <p class="text-center mb-1">{{ user.email }}</p>
              <p class="text-center text-muted mb-1">{{ user.dir }}</p>
            </div>
            <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
          </div>
          <div class="offcanvas-body">
            <h6 class="border-bottom pb-2">Tus Reservas</h6>

            {% if reserva_forms %}
              <div class="d-flex flex-column gap-3">
                {% for reserva, reserva_form in reserva_forms %}
                  <div class="card shadow-sm" style="background: snow;">
                    <div class="row g-0">
                      <!-- Imagen del evento -->
                      <div class="col-md-4">
                        <img src="{{ reserva.evento.image.url }}" class="img-fluid rounded-start h-100 object-fit-cover" alt="{{ reserva.evento.nombreE }}" style="max-height: 150px;">
                        {% if not reserva.pagar %}
                            <button type="button" class="btn btn-success m-4" onclick="abrirModalPagar('reserva', {{ reserva.pk }})">
                                <i class="bi bi-credit-card"></i> Pagar
                            </button>
                        {% endif %}
                      </div>
                      <!-- Detalles -->
                      <div class="col-md-8">
                        <div class="card-body">
                          <h5 class="card-title">{{ reserva.evento.nombreE }}</h5>
                          <p class="card-text text-muted">{{ reserva.evento.description|truncatewords:15 }}</p>

                          <ul class="list-unstyled small">
                            <li><strong>Fecha:</strong> {{ reserva.evento.fechahora|date:"d/m/Y H:i" }}</li>
                            <li><strong>Personas:</strong> {{ reserva.num_personas }}</li>
                            <li><strong>Cover:</strong> ${{ reserva.evento.preciocover }}</li>
                            <li><strong>Precio total:</strong> ${{ reserva.get_total }}</li>
                          </ul>

                          <!-- Estado -->
                          <div class="mt-2">
                            {% if reserva.estado %}
                              <span class="badge bg-success">Confirmada</span>
                            {% else %}
                              <span class="badge bg-warning text-dark">Pendiente</span>
                            {% endif %}
                          </div>

                          <!-- Acciones (solo si no está confirmada) -->
                          {% if not reserva.pagar %}
                            <div class="mt-3 d-flex gap-2">
                              <!-- Botón Editar -->
                              <button class="btn btn-sm btn-outline-primary"
                                      data-bs-toggle="modal"
                                      data-bs-target="#editarReservaModal{{ reserva.pk }}">
                                <i class="bi bi-pencil"></i> Editar
                              </button>

                              <!-- Botón Eliminar -->
                              <button class="btn btn-sm btn-outline-danger"
                                      data-bs-toggle="modal"
                                      data-bs-target="#eliminarReservaModal{{ reserva.pk }}">
                                <i class="bi bi-trash"></i> Eliminar
                              </button>
                            </div>

                            <!-- Modal Editar -->
                            <div class="modal fade" id="editarReservaModal{{ reserva.pk }}" tabindex="-1">
                              <div class="modal-dialog">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title">Editar Reserva</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                  </div>
                                  <form method="post" action="{% url 'producto:updater' reserva.pk %}" enctype="multipart/form-data">
                                    {% csrf_token %}
                                    <div class="modal-body">
                                      <div class="mb-3">
                                          {% for field in reserva_form %}
                                            {% if field.name != 'estado' %}
                                              <div class="form-group mt-3">
                                                <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
                                                {{ field }}
                                                {% if field.errors %}
                                                  <div class="alert alert-danger small mt-1">
                                                    {{ field.errors|first }}
                                                  </div>
                                                {% endif %}
                                              </div>
                                            {% endif %}
                                          {% endfor %}
                                      </div>
                                    </div>
                                    <div class="modal-footer">
                                      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                      <button type="submit" class="btn btn-primary">Guardar</button>
                                    </div>
                                  </form>
                                </div>
                              </div>
                            </div>

                            <!-- Modal Eliminar -->
                            <div class="modal fade" id="eliminarReservaModal{{ reserva.pk }}" tabindex="-1">
                              <div class="modal-dialog">
                                <div class="modal-content">
                                  <div class="modal-header">
                                    <h5 class="modal-title text-danger">Eliminar Reserva</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                  </div>
                                  <div class="modal-body">
                                    ¿Estás seguro de que deseas eliminar esta reserva para <strong>{{ reserva.evento.nombreE }}</strong>?
                                  </div>
                                  <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                    <a href="{% url 'producto:deleter' reserva.pk %}" class="btn btn-danger">Eliminar</a>
                                  </div>
                                </div>
                              </div>
                            </div>
                          {% else %}
                            <small class="text-muted mt-2">Esta reserva no se puede modificar.</small>
                          {% endif %}
                        </div>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-center text-muted">No tienes reservas aún.</p>
            {% endif %}

            <h6 class="border-bottom pt-3 pb-2">Tus Contratos</h6>

            {% if contratos %}
              <div class="d-flex flex-column">
                {% for contrato in contratos %}
                  <div class="card shadow-sm" style="background: snow;">
                    <div class="row">
                      <!-- Detalles -->
                        <div class="card-body ms-3">
                            <h5 class="card-title">{{ contrato }}</h5>
                            <p class="card-text">{{ contrato.archivo.name|cut:"contratos_firmados/" }}</p>
                            <strong>Fecha de carga:</strong> {{ contrato.fecha_subida|date:"d/m/Y H:i" }}

                            <!-- Estado -->
                            <div class="mb-2">
                            {% if contrato.estado %}
                              <span class="badge bg-success">Confirmado</span>
                            {% else %}
                              <span class="badge bg-warning text-dark">Pendiente</span>
                            {% endif %}
                            </div>

                            {% if not contrato.estado %}
                            <!-- Botón Editar -->
                            <button class="btn btn-sm btn-outline-primary"
                                  data-bs-toggle="modal"
                                  data-bs-target="#editarContratoModal{{ contrato.pk }}">
                            <i class="bi bi-pencil"></i> Editar
                            </button>

                            <!-- Modal Editar -->
                            <div class="modal fade" id="editarContratoModal{{ contrato.pk }}" tabindex="-1">
                                <div class="modal-dialog">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title">Editar Contrato</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                                        </div>

                                        <form method="post" action="{% url 'producto:editarc' contrato.pk %}" enctype="multipart/form-data">
                                            {% csrf_token %}

                                            <div class="modal-body">
                                                <!-- Campo de archivo: opcional -->
                                                <div class="mb-3">
                                                    <label for="archivo_{{ contrato.pk }}" class="form-label">
                                                        Subir nuevo archivo (opcional)
                                                    </label>
                                                    <input
                                                        type="file"
                                                        class="form-control"
                                                        id="archivo_{{ contrato.pk }}"
                                                        name="archivo"
                                                        accept=".pdf,.jpg,.jpeg,.png">
                                                    <small class="text-muted">
                                                        Si no seleccionas un archivo, se mantendrá el actual.
                                                    </small>
                                                </div>

                                                <!-- Checkbox de confirmado: solo para admin -->
                                                {% if user.is_staff %}
                                                    <div class="mb-3 form-check">
                                                        <input
                                                            type="checkbox"
                                                            class="form-check-input"
                                                            id="confirmado_{{ contrato.pk }}"
                                                            name="confirmado"
                                                            {% if contrato.estado %}checked{% endif %}>
                                                        <label class="form-check-label" for="confirmado_{{ contrato.pk }}">
                                                            Marcar como confirmado
                                                        </label>
                                                        <small class="text-muted d-block">
                                                            Marca si el contrato ya fue revisado y es válido.
                                                        </small>
                                                    </div>
                                                {% endif %}
                                            </div>

                                            <div class="modal-footer">
                                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                                                <button type="submit" class="btn btn-primary">Guardar Cambios</button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-center text-muted">No tienes contratos aún.</p>
            {% endif %}
          </div>
        </div>
    {% endif %}
<!-- Modal Pago Genérico -->
<div class="modal fade" id="modalPagar" tabindex="-1" style="z-index: 10000">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Subir comprobante de pago</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form method="post" enctype="multipart/form-data" id="formPagar">
        {% csrf_token %}

        <div class="modal-body">
          <!-- Fila: Imagen y textos -->
          <div class="d-flex mb-3">
            <!-- Imagen de referencia -->
            <div class="justify-content-start me-4">
                <img src="{% static 'img/Pagar.png' %}" alt="Ejemplo de pago" class="img-fluid rounded shadow-sm" style="max-height: 180px; object-fit: cover;">
            </div>

            <div class="align-content-center">
              <h6>9212-9598-7237-7827</h6>
              <h6># 55405253</h6>
            </div>
          </div>
                <strong>1.</strong> Realiza el pago a través de Transfermovil.
                <br>
                <strong>2.</strong> Sube una captura clara del comprobante.
              <!-- Campo de subida -->
              <div class="mb-3 mt-3">
                <label for="imagen_pago" class="form-label">Selecciona tu comprobante</label>
                <input type="file" class="form-control" id="imagen_pago" name="imagen_pago" accept="image/*" required>
                <small class="text-muted">Formatos: JPG, PNG, WEBP. Debe ser legible.</small>
              </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
          <button type="submit" class="btn btn-success">Enviar comprobante</button>
        </div>
      </form>
    </div>
  </div>
</div>
</header>

<script>
function abrirModalPagar(tipo, pk) {
    // Usa Django para generar la URL base con namespace
    const baseUrl = "{% url 'producto:subir_pago' tipo='reserva' pk=1 %}";
    const actionUrl = baseUrl
        .replace('reserva', tipo)
        .replace('1', pk);

    document.getElementById('formPagar').action = actionUrl;

    const modal = new bootstrap.Modal(document.getElementById('modalPagar'));
    modal.show();
}
</script>
